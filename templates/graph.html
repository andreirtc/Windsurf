{% extends "base.html" %}

{% block title %}Graph - Metro Manila Railway Network{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card bg-transparent mb-4">
        <div class="card-body content-wrapper">
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('works') }}" class="text-purple">Works</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Graph</li>
                </ol>
            </nav>

            <h2 class="text-center text-white mb-4">Metro Manila Railway Network</h2>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label for="startStation">Departure Station:</label>
                        <select class="form-select custom-select" id="startStation">
                            <option value="">Select departure station</option>
                            <optgroup label="LRT Line 1 (Red Line)">
                            </optgroup>
                            <optgroup label="LRT Line 2 (Purple Line)">
                            </optgroup>
                            <optgroup label="MRT Line 3 (Yellow Line)">
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="endStation">Destination Station:</label>
                        <select class="form-select custom-select" id="endStation">
                            <option value="">Select destination station</option>
                            <optgroup label="LRT Line 1 (Red Line)">
                            </optgroup>
                            <optgroup label="LRT Line 2 (Purple Line)">
                            </optgroup>
                            <optgroup label="MRT Line 3 (Yellow Line)">
                            </optgroup>
                        </select>
                    </div>
                    <button class="btn btn-custom mb-3" id="findPathBtn">Find Shortest Path</button>
                    
                    <div class="form-group">
                        <label>Railway Lines:</label>
                        <div class="line-legend">
                            <div class="line-item">
                                <span class="line-color lrt1"></span>
                                <span>LRT Line 1 (Red Line)</span>
                            </div>
                            <div class="line-item">
                                <span class="line-color lrt2"></span>
                                <span>LRT Line 2 (Purple Line)</span>
                            </div>
                            <div class="line-item">
                                <span class="line-color mrt3"></span>
                                <span>MRT Line 3 (Yellow Line)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="path-details-container mt-4">
                        <h4 class="text-white mb-3">Path Details:</h4>
                        <div id="pathDetails" class="path-details"></div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div id="networkVisualization" class="network-container">
                        <object id="railwayMap" data="{{ url_for('static', filename='images/railway_network.svg') }}" type="image/svg+xml" class="railway-map"></object>
                        <div class="zoom-controls">
                            <button class="zoom-btn" id="zoomIn">+</button>
                            <button class="zoom-btn" id="zoomOut">−</button>
                            <button class="zoom-btn" id="resetZoom">↺</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
<style>
.container {
    padding-top: 2rem;
}

.text-purple {
    color: #9b4dca !important;
}

.text-purple:hover {
    color: #ff69b4 !important;
    text-decoration: none;
}

.breadcrumb-nav {
    background: rgba(155, 77, 202, 0.1);
    padding: 10px 20px;
    border-radius: 10px;
    margin-bottom: 2rem;
}

.breadcrumb {
    background: transparent;
    padding: 0;
    margin: 0;
}

.breadcrumb-item {
    color: rgba(255, 255, 255, 0.5);
}

.breadcrumb-item.active {
    color: white;
}

.breadcrumb-item + .breadcrumb-item::before {
    color: rgba(255, 255, 255, 0.3);
}

.graph-display {
    background: rgba(35, 31, 43, 0.95);
    border-radius: 8px;
    width: 100%;
    height: 600px;
    position: relative;
}

.path-details {
    color: white;
    font-size: 14px;
    background: rgba(35, 31, 43, 0.95);
    border-radius: 8px;
    padding: 15px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.custom-select {
    background-color: rgba(35, 31, 43, 0.95) !important;
    color: white !important;
    border: 1px solid rgba(155, 77, 202, 0.2) !important;
}

.custom-select option, .custom-select optgroup {
    background-color: rgba(35, 31, 43, 0.95);
    color: white;
}

.line-legend {
    background: rgba(35, 31, 43, 0.95);
    padding: 15px;
    border-radius: 8px;
    margin-top: 10px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.content-wrapper {
    background: rgba(44, 38, 54, 0.95); /* Purple-tinted dark background */
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.btn-custom {
    background-color: #9b4dca;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    transition: background-color 0.3s;
}

.btn-custom:hover {
    background-color: #7b3da0;
    color: white;
}

label {
    color: white;
    margin-bottom: 0.5rem;
}

.line-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    color: white;
}

.line-item span {
    color: white;
}

.line-color {
    width: 20px;
    height: 4px;
    margin-right: 10px;
    border-radius: 2px;
}

.lrt1 {
    background-color: #008000;  /* Green */
}

.lrt2 {
    background-color: #800080;  /* Purple */
}

.mrt3 {
    background-color: #FFA500;  /* Yellow */
}

.path-details-container {
    background: rgba(35, 31, 43, 0.95);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    height: 300px;
    overflow-y: auto;
}

.zoom-controls {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(35, 31, 43, 0.95);
    padding: 5px;
    border-radius: 5px;
}

.zoom-btn {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
}

.zoom-btn:hover {
    color: #ccc;
}

.station-highlight {
    fill: #00FFFF !important;
    r: 15 !important;
    box-shadow: 0 0 20px #00FFFF,
               0 0 40px #00FFFF,
               0 0 60px #00FFFF,
               0 0 80px #00FFFF,
               0 0 100px #00FFFF !important;
}

.path-highlight {
    stroke: #00FFFF !important;
    stroke-width: 10 !important;
    box-shadow: 0 0 20px #00FFFF,
               0 0 40px #00FFFF,
               0 0 60px #00FFFF !important;
}

.hover-highlight {
    fill: #00FFFF !important;
    r: 12 !important;
}

.selected-station {
    fill: #00FFFF !important;
    r: 12 !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startSelect = document.getElementById('startStation');
    const endSelect = document.getElementById('endStation');
    const findPathBtn = document.getElementById('findPathBtn');
    const pathDetails = document.getElementById('pathDetails');
    const svgObject = document.getElementById('railwayMap');
    const zoomInBtn = document.getElementById('zoomIn');
    const zoomOutBtn = document.getElementById('zoomOut');
    const resetZoomBtn = document.getElementById('resetZoom');
    let currentScale = 1;
    let isDragging = false;
    let startX, startY, translateX = 0, translateY = 0;
    
    // Initialize stations data with correct order
    const stations = {
        'LRT1': [
            'Fernando Poe Jr.',
            'Balintawak',
            'Monumento',
            '5th Avenue',
            'R. Papa',
            'Abad Santos',
            'Blumentritt',
            'Tayuman',
            'Bambang',
            'Doroteo Jose',
            'Carriedo',
            'Central Terminal',
            'United Nations',
            'Pedro Gil',
            'Quirino',
            'Vito Cruz',
            'Gil Puyat',
            'Libertad',
            'EDSA',
            'Baclaran',
            'Redemptorist - Aseana',
            'MIA',
            'Asia World',
            'Ninoy Aquino Ave.',
            'Dr. Santos'
        ],
        'LRT2': [
            'Recto',
            'Legarda',
            'Pureza',
            'V. Mapa',
            'J. Ruiz',
            'Gilmore',
            'Betty Go-Belmonte',
            'Araneta Center-Cubao',
            'Anonas',
            'Katipunan',
            'Santolan',
            'Marikina-Pasig',
            'Antipolo'
        ],
        'MRT3': [
            'North Avenue',
            'Quezon Avenue',
            'GMA Kamuning',
            'Araneta Center-Cubao',
            'Santolan-Annapolis',
            'Ortigas',
            'Shaw Boulevard',
            'Boni',
            'Guadalupe',
            'Buendia',
            'Ayala',
            'Magallanes',
            'Taft Avenue'
        ]
    };

    // Populate dropdowns
    function populateDropdowns() {
        const lines = ['LRT1', 'LRT2', 'MRT3'];
        [startSelect, endSelect].forEach(select => {
            const groups = select.getElementsByTagName('optgroup');
            lines.forEach((line, index) => {
                stations[line].forEach(station => {
                    const option = new Option(station, station);
                    groups[index].appendChild(option.cloneNode(true));
                });
            });
        });
    }

    svgObject.addEventListener('load', function() {
        const svgDoc = svgObject.contentDocument;
        const svg = svgDoc.querySelector('svg');
        
        // Mouse wheel zoom
        svg.addEventListener('wheel', function(e) {
            e.preventDefault();
            const delta = e.deltaY;
            if (delta > 0) {
                currentScale = Math.max(0.5, currentScale - 0.1);
            } else {
                currentScale = Math.min(2, currentScale + 0.1);
            }
            updateTransform(svg);
        });

        // Dragging functionality
        svg.addEventListener('mousedown', function(e) {
            isDragging = true;
            startX = e.clientX - translateX;
            startY = e.clientY - translateY;
            svg.style.cursor = 'grabbing';
        });

        svg.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            translateX = e.clientX - startX;
            translateY = e.clientY - startY;
            updateTransform(svg);
        });

        svg.addEventListener('mouseup', function() {
            isDragging = false;
            svg.style.cursor = 'grab';
        });

        svg.addEventListener('mouseleave', function() {
            isDragging = false;
            svg.style.cursor = 'grab';
        });

        // Initialize cursor
        svg.style.cursor = 'grab';
    });

    // Zoom button controls
    zoomInBtn.addEventListener('click', function() {
        currentScale = Math.min(2, currentScale + 0.1);
        updateTransform(svgObject.contentDocument.querySelector('svg'));
    });

    zoomOutBtn.addEventListener('click', function() {
        currentScale = Math.max(0.5, currentScale - 0.1);
        updateTransform(svgObject.contentDocument.querySelector('svg'));
    });

    resetZoomBtn.addEventListener('click', function() {
        currentScale = 1;
        translateX = 0;
        translateY = 0;
        updateTransform(svgObject.contentDocument.querySelector('svg'));
    });

    function updateTransform(element) {
        element.style.transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale})`;
        element.style.transformOrigin = 'center';
    }

    // Path finding
    findPathBtn.addEventListener('click', function() {
        const start = startSelect.value;
        const end = endSelect.value;
        
        if (!start || !end) {
            pathDetails.innerHTML = '<div class="alert alert-warning">Please select both stations</div>';
            return;
        }

        fetch('/find_path', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                start: start,
                end: end
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (!data || !data.path) {
                throw new Error('Invalid path data');
            }
            
            const path = data.path;
            const totalTime = data.total_time;
            
            // Format path with arrows
            const pathStr = path.map(p => p.station).join(' → ');
            
            let pathDetailsHtml = `
                <div class="path-details-content">
                    <p class="total-time">Estimated Travel Time: ${totalTime} minutes</p>
                    <p class="route-title">Route:</p>
                    <p class="route-path">${pathStr}</p>
                </div>
            `;
            
            pathDetails.innerHTML = pathDetailsHtml;
            
            // Highlight path
            highlightPath(path);
        })
        .catch(error => {
            console.error('Error:', error);
            pathDetails.innerHTML = '<div class="alert alert-danger">Could not find a path between these stations</div>';
        });
    });

    function normalizeStationName(name) {
        return name.toLowerCase()
            .replace(/[-–—]/g, ' ')  // Convert all dash types to space
            .replace(/\s+/g, ' ')    // Normalize spaces
            .trim();
    }

    function findStationElement(stationData) {
        const svgDoc = svgObject.contentDocument;
        if (!svgDoc) return null;

        const stationName = stationData.station;
        const normalizedName = normalizeStationName(stationName);
        const line = stationData.line;
        console.log("Looking for station name:", stationName, "normalized:", normalizedName, "line:", line);

        // Special cases for stations with distant text elements
        const specialStationCoords = {
            'santolan annapolis': { x: 550, y: 250, range: 30 },  // MRT-3
            'araneta center cubao': [
                { x: 550, y: 175, range: 30, line: 'MRT Line 3' },  // MRT-3 version
                { x: 450, y: 175, range: 30, line: 'LRT Line 2' }   // LRT-2 version
            ]
        };

        // Check if this is a special case station
        if (specialStationCoords[normalizedName]) {
            const coords = specialStationCoords[normalizedName];
            if (Array.isArray(coords)) {
                // For stations with multiple positions (like Araneta)
                const coordsForLine = coords.find(c => !line || line.includes(c.line));
                if (coordsForLine) {
                    return findNearestEllipse(svgDoc, coordsForLine.x, coordsForLine.y, coordsForLine.range);
                }
            } else {
                // For single position stations (like Santolan-Annapolis)
                return findNearestEllipse(svgDoc, coords.x, coords.y, coords.range);
            }
        }

        // Special cases mapping for text matching
        const specialCases = {
            'redemptorist aseana': 'redemptionist aseana',
            'betty go belmonte': 'betty go belmo',
            'araneta center cubao': 'araneta center–cubao',
            'santolan annapolis': 'santolan–annapolis'
        };

        // First find all matching text elements
        const allTexts = Array.from(svgDoc.querySelectorAll('text'));
        const matchingTexts = allTexts.filter(text => {
            const textContent = normalizeStationName(text.textContent);
            const searchName = specialCases[normalizedName] || normalizedName;
            return textContent === searchName || textContent.startsWith(searchName);
        });

        if (matchingTexts.length === 0) {
            console.log("No text element found for station:", stationName);
            return null;
        }

        // Find all potential ellipses for these texts
        const candidates = [];
        matchingTexts.forEach(text => {
            const x = parseFloat(text.getAttribute('x'));
            const y = parseFloat(text.getAttribute('y'));
            console.log("Found matching text at coordinates:", { x, y, text: text.textContent });
            
            const allEllipses = Array.from(svgDoc.querySelectorAll('ellipse'));
            allEllipses.forEach(ellipse => {
                const cx = parseFloat(ellipse.getAttribute('cx'));
                const cy = parseFloat(ellipse.getAttribute('cy'));
                const distance = Math.sqrt(Math.pow(cx - x, 2) + Math.pow(cy - y, 2));

                // Log all nearby ellipses for debugging
                if (distance < 100) {
                    console.log("Found nearby ellipse:", { 
                        distance, 
                        coordinates: { x: cx, y: cy },
                        textCoords: { x, y }
                    });
                }

                if (distance < 100) {  // Increased distance threshold
                    candidates.push({ ellipse, distance, x: cx, y: cy });
                }
            });
        });

        // Sort candidates by distance
        candidates.sort((a, b) => a.distance - b.distance);
        const closest = candidates[0];

        if (!closest) {
            console.log("No nearby ellipse found in the correct range");
            return null;
        }

        console.log("Selected station ellipse for:", stationName, "at coordinates:", 
                   { x: closest.x, y: closest.y }, "distance:", closest.distance);
        return closest.ellipse;
    }

    // Helper function to find nearest ellipse to coordinates
    function findNearestEllipse(svgDoc, targetX, targetY, range) {
        const allEllipses = Array.from(svgDoc.querySelectorAll('ellipse'));
        let closest = null;
        let minDistance = range || 30;

        allEllipses.forEach(ellipse => {
            const cx = parseFloat(ellipse.getAttribute('cx'));
            const cy = parseFloat(ellipse.getAttribute('cy'));
            const distance = Math.sqrt(Math.pow(cx - targetX, 2) + Math.pow(cy - targetY, 2));

            if (distance < minDistance) {
                closest = ellipse;
                minDistance = distance;
            }
        });

        if (closest) {
            // Store original size if not already stored
            if (!closest.hasAttribute('data-original-rx')) {
                closest.setAttribute('data-original-rx', closest.getAttribute('rx'));
                closest.setAttribute('data-original-ry', closest.getAttribute('ry'));
            }
        }

        return closest;
    }

    function resetHighlights() {
        const svgDoc = svgObject.contentDocument;
        if (!svgDoc) return;

        // Reset all elements to their original styles
        svgDoc.querySelectorAll('ellipse').forEach(station => {
            // Reset size to original stored values
            if (station.hasAttribute('data-original-rx') && station.hasAttribute('data-original-ry')) {
                station.setAttribute('rx', station.getAttribute('data-original-rx'));
                station.setAttribute('ry', station.getAttribute('data-original-ry'));
            }
            // Clear all styles
            station.removeAttribute('style');
        });

        // Reset all paths
        svgDoc.querySelectorAll('path').forEach(path => {
            const originalStyle = path.getAttribute('data-original-style');
            if (originalStyle) {
                path.setAttribute('style', originalStyle);
            } else {
                // Store original style if not already stored
                path.setAttribute('data-original-style', path.getAttribute('style') || '');
                // Clear highlight styles
                path.removeAttribute('style');
            }
        });
    }

    function highlightPath(path) {
        const svgDoc = svgObject.contentDocument;
        if (!svgDoc) return;

        // Make sure to reset first
        resetHighlights();

        // Sequential highlighting with animation
        path.forEach((station, index) => {
            setTimeout(() => {
                const stationElement = findStationElement(station);
                if (stationElement) {
                    stationElement.style.fill = '#00FFFF';
                    stationElement.style.stroke = '#0000FF';
                    stationElement.style.strokeWidth = '3';
                    
                    const originalRx = parseFloat(stationElement.getAttribute('data-original-rx') || '6');
                    const originalRy = parseFloat(stationElement.getAttribute('data-original-ry') || '6');
                    stationElement.setAttribute('rx', (originalRx * 1.5).toString());
                    stationElement.setAttribute('ry', (originalRy * 1.5).toString());

                    if (index < path.length - 1) {
                        const nextStation = path[index + 1];
                        highlightConnection(station, nextStation);
                    }
                }
            }, index * 800);
        });
    }

    function findConnectionPath(station1, station2) {
        const svgDoc = svgObject.contentDocument;
        if (!svgDoc) return null;

        const name1 = station1.station;
        const name2 = station2.station;
        console.log("Looking for path between stations:", name1, name2);

        // Find the text elements for both stations
        const allTexts = Array.from(svgDoc.querySelectorAll('text'));
        const text1 = allTexts.find(text => text.textContent.trim() === name1);
        const text2 = allTexts.find(text => text.textContent.trim() === name2);

        if (!text1 || !text2) {
            console.log("Could not find text elements for stations");
            return null;
        }

        // Get coordinates of both stations
        const group1 = text1.parentElement;
        const group2 = text2.parentElement;
        const ellipse1 = group1?.querySelector('ellipse');
        const ellipse2 = group2?.querySelector('ellipse');

        if (!ellipse1 || !ellipse2) {
            console.log("Could not find ellipses for stations");
            return null;
        }

        // Find path that connects these stations
        const paths = Array.from(svgDoc.querySelectorAll('path'));
        console.log("Total paths found:", paths.length);

        // Look for a path that has style matching draw.io path style
        for (const path of paths) {
            const style = path.getAttribute('style') || '';
            if (style.includes('strokeColor=#FFA500') && style.includes('strokeWidth=7')) {
                // Check if this path connects our stations
                const d = path.getAttribute('d');
                const cx1 = ellipse1.getAttribute('cx');
                const cy1 = ellipse1.getAttribute('cy');
                const cx2 = ellipse2.getAttribute('cx');
                const cy2 = ellipse2.getAttribute('cy');

                if (d && d.includes(`${cx1},${cy1}`) && d.includes(`${cx2},${cy2}`)) {
                    console.log("Found connecting path");
                    return path;
                }
            }
        }

        console.log("No path found between", name1, "and", name2);
        return null;
    }

    function highlightConnection(station1, station2) {
        const path = findConnectionPath(station1, station2);
        if (path) {
            // Bright blue highlight for paths too
            path.style.stroke = '#00FFFF';
            path.style.strokeWidth = '10';
        }
    }

    // Initialize
    populateDropdowns();
});
</script>
{% endblock %}
