{% extends "base.html" %}

{% block title %}Graph - Metro Manila Railway Network{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card bg-transparent mb-4">
        <div class="card-body content-wrapper">
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('works') }}" class="text-purple">Works</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Graph</li>
                </ol>
            </nav>

            <h2 class="text-center text-white mb-4">Metro Manila Railway Network</h2>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group mb-3">
                        <label for="startStation">Departure Station:</label>
                        <select class="form-select custom-select" id="startStation">
                            <option value="">Select departure station</option>
                            <optgroup label="LRT Line 1 (Green Line)">
                            </optgroup>
                            <optgroup label="LRT Line 2 (Purple Line)">
                            </optgroup>
                            <optgroup label="MRT Line 3 (Yellow Line)">
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-group mb-3">
                        <label for="endStation">Destination Station:</label>
                        <select class="form-select custom-select" id="endStation">
                            <option value="">Select destination station</option>
                            <optgroup label="LRT Line 1 (Green Line)">
                            </optgroup>
                            <optgroup label="LRT Line 2 (Purple Line)">
                            </optgroup>
                            <optgroup label="MRT Line 3 (Yellow Line)">
                            </optgroup>
                        </select>
                    </div>
                    <button class="btn btn-custom mb-3" id="findPathBtn">Find Shortest Path</button>
                    
                    <div class="form-group">
                        <label>Railway Lines:</label>
                        <div class="line-legend">
                            <div class="line-item">
                                <span class="line-color lrt1"></span>
                                <span>LRT Line 1 (Green Line)</span>
                            </div>
                            <div class="line-item">
                                <span class="line-color lrt2"></span>
                                <span>LRT Line 2 (Purple Line)</span>
                            </div>
                            <div class="line-item">
                                <span class="line-color mrt3"></span>
                                <span>MRT Line 3 (Yellow Line)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Add operations log section -->
                    <div class="operations-log-container">
                        <h4 class="text-white mb-3">Operations Log:</h4>
                        <div id="operationsLog" class="log-content"></div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div id="networkVisualization">
                        <div id="graphContainer" class="graph-display"></div>
                    </div>
                    <div class="mt-4">
                        <h4 class="text-white mb-3">Path Details:</h4>
                        <div id="pathDetails" class="path-details"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/dist/vis-network.min.css" rel="stylesheet" type="text/css" />
<style>
.container {
    padding-top: 2rem;
}

.text-purple {
    color: #9b4dca !important;
}

.text-purple:hover {
    color: #ff69b4 !important;
    text-decoration: none;
}

.breadcrumb-nav {
    background: rgba(155, 77, 202, 0.1);
    padding: 10px 20px;
    border-radius: 10px;
    margin-bottom: 2rem;
}

.breadcrumb {
    background: transparent;
    padding: 0;
    margin: 0;
}

.breadcrumb-item {
    color: rgba(255, 255, 255, 0.5);
}

.breadcrumb-item.active {
    color: white;
}

.breadcrumb-item + .breadcrumb-item::before {
    color: rgba(255, 255, 255, 0.3);
}

.graph-display {
    background: rgba(35, 31, 43, 0.95);
    border-radius: 8px;
    width: 100%;
    height: 600px;
    position: relative;
}

.path-details {
    color: white;
    font-size: 14px;
    background: rgba(35, 31, 43, 0.95);
    border-radius: 8px;
    padding: 15px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.custom-select {
    background-color: rgba(35, 31, 43, 0.95) !important;
    color: white !important;
    border: 1px solid rgba(155, 77, 202, 0.2) !important;
}

.custom-select option, .custom-select optgroup {
    background-color: rgba(35, 31, 43, 0.95);
    color: white;
}

.line-legend {
    background: rgba(35, 31, 43, 0.95);
    padding: 15px;
    border-radius: 8px;
    margin-top: 10px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
}

.content-wrapper {
    background: rgba(44, 38, 54, 0.95); /* Purple-tinted dark background */
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.btn-custom {
    background-color: #9b4dca;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 5px;
    transition: background-color 0.3s;
}

.btn-custom:hover {
    background-color: #7b3da0;
    color: white;
}

label {
    color: white;
    margin-bottom: 0.5rem;
}

.line-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
    color: white;
}

.line-item span {
    color: white;
}

.line-color {
    width: 20px;
    height: 4px;
    margin-right: 10px;
    border-radius: 2px;
}

.lrt1 {
    background-color: #4CAF50;  /* Green */
}

.lrt2 {
    background-color: #9C27B0;  /* Purple */
}

.mrt3 {
    background-color: #FFC107;  /* Yellow */
}

.operations-log-container {
    background: rgba(35, 31, 43, 0.95);
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;
    height: 300px;
    overflow-y: auto;
}

.log-content {
    color: white;
    font-size: 14px;
}

.log-entry {
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.log-entry:last-child {
    border-bottom: none;
}

.station-name {
    font-weight: bold;
}

.line-info {
    font-size: 12px;
    color: #ccc;
}
</style>
{% endblock %}

{% block extra_js %}
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis-network/9.1.2/dist/vis-network.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const startSelect = document.getElementById('startStation');
    const endSelect = document.getElementById('endStation');
    const findPathBtn = document.getElementById('findPathBtn');
    const pathDetails = document.getElementById('pathDetails');
    const container = document.getElementById('graphContainer');
    
    let network = null;
    let stations = [];
    let lines = {};
    
    // Initialize the network with empty data first
    const data = {
        nodes: new vis.DataSet([]),
        edges: new vis.DataSet([])
    };
    
    const options = {
        nodes: {
            shape: 'dot',
            size: 20,
            font: {
                size: 16,
                color: '#ffffff',
                face: 'Arial',
                strokeWidth: 2,
                strokeColor: 'rgba(0,0,0,0.5)'
            },
            borderWidth: 2,
            scaling: {
                min: 20,
                max: 30
            }
        },
        edges: {
            width: 4,
            selectionWidth: 6,
            smooth: {
                type: 'straightCross',
                roundness: 0.5
            }
        },
        physics: {
            enabled: true,
            barnesHut: {
                gravitationalConstant: -3000,
                centralGravity: 0.5,
                springLength: 200,
                springConstant: 0.05,
                damping: 0.1
            },
            stabilization: {
                iterations: 2000,
                updateInterval: 25
            }
        },
        interaction: {
            hover: true,
            tooltipDelay: 200,
            zoomView: true,
            dragView: true,
            navigationButtons: true,
            keyboard: true
        },
        height: '600px',
        layout: {
            randomSeed: 42,
            improvedLayout: true,
            hierarchical: {
                enabled: true,
                direction: 'UD',
                sortMethod: 'directed',
                nodeSpacing: 150,
                levelSeparation: 150,
                treeSpacing: 200
            }
        }
    };
    
    // Create network with empty data first
    network = new vis.Network(container, data, options);
    
    // Fetch stations and update the visualization
    fetch('/get_stations')
        .then(response => response.json())
        .then(data => {
            stations = data.stations;
            lines = data.lines;
            
            // Populate dropdowns with grouped stations
            const startGroups = startSelect.getElementsByTagName('optgroup');
            const endGroups = endSelect.getElementsByTagName('optgroup');
            
            // LRT1 stations
            lines.LRT1.forEach(station => {
                const option1 = new Option(station, station);
                const option2 = new Option(station, station);
                startGroups[0].appendChild(option1);
                endGroups[0].appendChild(option2.cloneNode(true));
            });
            
            // LRT2 stations
            lines.LRT2.forEach(station => {
                const option1 = new Option(station, station);
                const option2 = new Option(station, station);
                startGroups[1].appendChild(option1);
                endGroups[1].appendChild(option2.cloneNode(true));
            });
            
            // MRT3 stations
            lines.MRT3.forEach(station => {
                const option1 = new Option(station, station);
                const option2 = new Option(station, station);
                startGroups[2].appendChild(option1);
                endGroups[2].appendChild(option2.cloneNode(true));
            });
            
            // Create and update the network visualization
            createNetwork(lines);
        });
    
    function createNetwork(lines) {
        const container = document.getElementById('graphContainer');
        
        const nodePositions = {
            // LRT-1 (Red Line) - Vertical alignment
            'Fernando Poe Jr.': { x: -200, y: -250 },
            'Balintawak': { x: -200, y: -220 },
            'Monumento': { x: -200, y: -190 },
            '5th Avenue': { x: -200, y: -160 },
            'R. Papa': { x: -200, y: -130 },
            'Abad Santos': { x: -200, y: -100 },
            'Blumentritt': { x: -200, y: -70 },
            'Tayuman': { x: -200, y: -40 },
            'Bambang': { x: -200, y: -10 },
            'Doroteo Jose': { x: -200, y: 20 },
            'Carriedo': { x: -200, y: 50 },
            'Central Terminal': { x: -200, y: 80 },
            'United Nations': { x: -200, y: 110 },
            'Pedro Gil': { x: -200, y: 140 },
            'Quirino': { x: -200, y: 170 },
            'Vito Cruz': { x: -200, y: 200 },
            'Gil Puyat': { x: -200, y: 230 },
            'Libertad': { x: -200, y: 260 },
            'EDSA': { x: -200, y: 290 },
            'Baclaran': { x: -200, y: 320 },

            // LRT-2 (Green Line) - Horizontal alignment
            'Recto': { x: -150, y: 50 },
            'Legarda': { x: -100, y: 50 },
            'Pureza': { x: -50, y: 50 },
            'V. Mapa': { x: 0, y: 50 },
            'J. Ruiz': { x: 50, y: 50 },
            'Gilmore': { x: 100, y: 50 },
            'Betty Go-Belmonte': { x: 150, y: 50 },
            'Araneta Center-Cubao': { x: 200, y: 50 },
            'Anonas': { x: 250, y: 50 },
            'Katipunan': { x: 300, y: 50 },
            'Santolan': { x: 350, y: 50 },
            'Marikina-Pasig': { x: 400, y: 50 },
            'Antipolo': { x: 450, y: 50 },

            // MRT-3 (Yellow Line) - Mixed alignment
            'North Avenue': { x: 200, y: -250 },
            'Quezon Avenue': { x: 200, y: -190 },
            'GMA Kamuning': { x: 200, y: -130 },
            'Santolan-Annapolis': { x: 200, y: 110 },
            'Ortigas': { x: 200, y: 170 },
            'Shaw Boulevard': { x: 200, y: 230 },
            'Boni': { x: 200, y: 260 },
            'Guadalupe': { x: 200, y: 290 },
            'Buendia': { x: 150, y: 290 },
            'Ayala': { x: 100, y: 290 },
            'Magallanes': { x: 50, y: 290 },
            'Taft Avenue': { x: -200, y: 290 }  // Connects with EDSA station
        };

        const nodes = new vis.DataSet();
        const edges = new vis.DataSet();
        const nodeMap = {};

        // Add nodes for each line with appropriate colors
        Object.entries(lines).forEach(([line, stations]) => {
            const color = line === 'LRT1' ? '#FF0000' : 
                         line === 'LRT2' ? '#008000' : 
                         '#FFA500';  // MRT3

            stations.forEach((station, index) => {
                if (nodePositions[station]) {
                    const nodeId = nodes.length + 1;
                    nodeMap[station] = nodeId;
                    
                    // Check if it's an interchange station
                    const isInterchange = (
                        station === 'Doroteo Jose' || 
                        station === 'Recto' || 
                        station === 'EDSA' || 
                        station === 'Taft Avenue' || 
                        station === 'Araneta Center-Cubao'
                    );

                    nodes.add({
                        id: nodeId,
                        label: station,
                        x: nodePositions[station].x,
                        y: nodePositions[station].y,
                        color: {
                            background: color,
                            border: isInterchange ? '#FFFFFF' : color
                        },
                        borderWidth: isInterchange ? 3 : 2,
                        size: isInterchange ? 18 : 15,
                        font: {
                            color: '#ffffff',
                            size: 12
                        },
                        fixed: true,
                        physics: false
                    });

                    // Add edges between consecutive stations in the same line
                    if (index > 0) {
                        const prevStation = stations[index - 1];
                        if (nodeMap[prevStation]) {
                            edges.add({
                                from: nodeMap[prevStation],
                                to: nodeId,
                                color: color,
                                width: 3,
                                smooth: {
                                    type: 'continuous',
                                    roundness: 0
                                }
                            });
                        }
                    }
                }
            });
        });

        // Network configuration
        const options = {
            nodes: {
                shape: 'dot',
                font: {
                    size: 12,
                    color: '#ffffff'
                }
            },
            edges: {
                smooth: {
                    type: 'continuous',
                    forceDirection: 'none',
                    roundness: 0
                }
            },
            physics: false,
            interaction: {
                dragNodes: false,
                dragView: true,
                zoomView: true
            }
        };

        // Create network
        const network = new vis.Network(container, { nodes, edges }, options);
        
        return { network, nodes, edges, nodeMap };
    }

    function addLogEntry(message) {
        const log = document.getElementById('operationsLog');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `${message}`;
        log.insertBefore(entry, log.firstChild);
    }
    
    findPathBtn.addEventListener('click', function() {
        const start = startSelect.value;
        const end = endSelect.value;
        
        if (!start || !end) {
            addLogEntry('⚠️ Please select both departure and destination stations.');
            return;
        }
        
        if (start === end) {
            addLogEntry('⚠️ Departure and destination stations cannot be the same.');
            return;
        }
        
        addLogEntry(`🔍 Finding shortest path from ${start} to ${end}...`);
        
        fetch('/find_path', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ start, end })
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                addLogEntry(`❌ Error: ${data.error}`);
                return;
            }
            
            const path = data.path;
            const totalTime = data.total_time;
            
            // Update path details
            let pathDetailsHtml = '<strong>Route Details:</strong><br><br>';
            path.forEach((station, index) => {
                if (index > 0) {
                    pathDetailsHtml += ' → ';
                }
                pathDetailsHtml += `<span class="station-name">${station.station}</span>`;
                pathDetailsHtml += `<span class="line-info">(${station.line})</span>`;
            });
            
            pathDetailsHtml += '<br><br><strong>Estimated Travel Time:</strong> ';
            pathDetailsHtml += `${totalTime} minutes`;
            
            document.getElementById('pathDetails').innerHTML = pathDetailsHtml;
            addLogEntry(`✅ Found path with ${path.length} stations (${totalTime} mins)`);
            
            // Highlight the path in the visualization
            highlightPath(path);
        })
        .catch(error => {
            addLogEntry(`❌ Error: Could not find path`);
            console.error('Error:', error);
        });
    });
    
    function highlightPath(path) {
        // Reset all edges to their original colors
        edges.forEach(edge => {
            const edgeData = edges.get(edge.id);
            edges.update({
                id: edge.id,
                color: edgeData.originalColor || edgeData.color,
                width: 4
            });
        });
        
        // Highlight the path
        for (let i = 0; i < path.length - 1; i++) {
            const fromNode = nodeMap[path[i].station];
            const toNode = nodeMap[path[i + 1].station];
            
            // Find the edge between these nodes
            const edgeId = edges.forEach(edge => {
                if ((edge.from === fromNode && edge.to === toNode) ||
                    (edge.from === toNode && edge.to === fromNode)) {
                    edges.update({
                        id: edge.id,
                        color: '#FF5252',
                        width: 6
                    });
                }
            });
        }
        
        // Animate the path
        let currentIndex = 0;
        function highlightNextStation() {
            if (currentIndex < path.length) {
                const nodeId = nodeMap[path[currentIndex].station];
                const node = nodes.get(nodeId);
                const originalSize = node.size || 20;
                const originalColor = node.color.background;
                
                // Highlight effect
                nodes.update({
                    id: nodeId,
                    size: originalSize * 1.5,
                    color: { background: '#FF5252', border: node.color.border }
                });
                
                // Reset after animation
                setTimeout(() => {
                    nodes.update({
                        id: nodeId,
                        size: originalSize,
                        color: { background: originalColor, border: node.color.border }
                    });
                    currentIndex++;
                    highlightNextStation();
                }, 1000);
            }
        }
        
        highlightNextStation();
        
        // Focus the network on the path
        const pathNodeIds = path.map(station => nodeMap[station.station]);
        network.fit({
            nodes: pathNodeIds,
            animation: {
                duration: 1000,
                easingFunction: 'easeInOutQuad'
            }
        });
    }
});
</script>
{% endblock %}
